{% load static %}
{% load chat_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OmarGPT</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'chat/images/fav.png' %}">

    <!-- Styles -->
    <link rel="stylesheet" href="{% static 'chat/css/styles.css' %}">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<div class="layout">

    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Logo -->
        <div class="sidebar-logo">
            <img src="{% static 'chat/images/logo.png' %}" alt="Logo" class="logo-image">
        </div>

        <ul>
            {% for cid in chat_ids %}
                <li style="display: flex; justify-content: space-between; align-items: center;">
                    <!-- Title left -->
                    <div id="chat-title-{{ cid }}" style="flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                        <a href="?chat_id={{ cid }}" class="{% if cid == current_chat %}active{% endif %}">
                            {% with chat_titles|get_item:cid as title %}
                                {% if title %}
                                    {{ title }}
                                {% else %}
                                    {{ cid|slice:":8" }}
                                {% endif %}
                            {% endwith %}
                        </a>
                    </div>

                    <!-- Actions right -->
                    <div class="chat-actions-right" style="display: flex; gap: 5px; align-items: center;">
                        <!-- Rename -->
                        <button onclick="showRenameForm('{{ cid }}')" class="action-button">
                            <i class="fas fa-pen"></i>
                        </button>

                        <!-- Delete -->
                        <form method="post" action="?delete_chat={{ cid }}" class="action-form">
                            {% csrf_token %}
                            <button type="submit" onclick="return confirm('⚠️ Are you sure you want to delete this chat?')" class="delete-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </li>
            {% endfor %}
        </ul>

        <!-- New Chat Button -->
        <form method="post" action="?new_chat=true" style="margin-top: 20px;">
            {% csrf_token %}
            <button class="btn new-chat" type="submit">
                <i class="fas fa-plus"></i> New Chat
            </button>
        </form>
    </div>

    <!-- Main Chat Area -->
    <div class="main">
        <!-- Navbar logo -->
        <div class="top-navbar">
            <img src="{% static 'chat/images/logo.png' %}" alt="Logo" class="navbar-logo">
        </div>

        <!-- Download Chat Button Top Right -->
        {% if current_chat %}
        <div class="download-button-top">
            <a href="?download_chat={{ current_chat }}" class="btn download-btn">
                <i class="fas fa-download"></i> Download Chat
            </a>
            
        </div>
        {% endif %}

        <!-- Chat history -->
        <div class="chat-history">
            {% if chat_messages %}
                <div class="response-box">
                    {% for line in chat_messages %}
                        {% if line|slice:":4" == "GPT:" %}
                            <div class="chat-bubble gpt">
                                <div class="bubble-content" {% if line|slice:"4:"|contains_arabic %}dir="rtl"{% endif %}>
                                    <strong>GPT:</strong> {{ line|slice:"4:" }}
                                </div>
                            </div>
                        {% else %}
                            <div class="chat-bubble user">
                                <div class="bubble-content" {% if line|slice:"5:"|contains_arabic %}dir="rtl"{% endif %}>
                                    <strong>You:</strong> {{ line|slice:"5:" }}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Chat input sticky -->
        <div class="chat-input-form">
            <form method="post">
                {% csrf_token %}
                {{ form.as_p }}
                <button class="btn send" type="submit">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </form>
        </div>
    </div>

</div>

<!-- Rename script -->
<script>
function showRenameForm(chatId) {
    const container = document.getElementById('chat-title-' + chatId);
    const currentTitle = container.innerText.trim();

    container.innerHTML = `
        <form method="post" action="?rename_chat=${chatId}" style="display: flex;">
            {% csrf_token %}
            <input type="text" name="new_title" value="${currentTitle}" style="width: 100px; font-size: 0.8em; background: #333; border: 1px solid #555; color: #eee; border-radius: 4px; padding: 2px;">
            <button type="submit" style="background: none; border: none; color: orange; font-size: 1em; cursor: pointer;">
                <i class="fas fa-save"></i>
            </button>
        </form>
    `;
}
</script>

</body>
</html>
